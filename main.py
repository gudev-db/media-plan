import streamlit as st
import pandas as pd
import google.generativeai as genai
import os
from typing import Dict, Any

# Configura√ß√£o inicial
st.set_page_config(
    layout="wide",
    page_title="IA de Planejamento de M√≠dia",
    page_icon="üìä"
)

# CSS personalizado
st.markdown("""
<style>
    /* Estilos gerais */
    .main {
        background-color: #f5f7fa;
    }
    .stTextInput input, .stSelectbox select, .stTextArea textarea {
        border-radius: 8px !important;
        border: 1px solid #d1d5db !important;
    }
    .stButton button {
        background-color: #4f46e5 !important;
        color: white !important;
        border-radius: 8px !important;
        padding: 10px 24px !important;
        font-weight: 500 !important;
    }
    .stButton button:hover {
        background-color: #4338ca !important;
    }
    /* Cards de resultado */
    .result-card {
        background-color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    /* Tabelas */
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    th {
        background-color: #f9fafb;
        font-weight: 600;
    }
    /* Abas */
    .stTabs [aria-selected="true"] {
        color: #4f46e5 !important;
        font-weight: 600 !important;
    }
</style>
""", unsafe_allow_html=True)

# Inicializar Gemini
gemini_api_key = os.getenv("GEM_API_KEY")
genai.configure(api_key=gemini_api_key)
modelo_texto = genai.GenerativeModel("gemini-1.5-flash")

# T√≠tulo do aplicativo
st.title("üìä IA para Planejamento de M√≠dia")
st.markdown("""
**Crie planos de m√≠dia otimizados com aloca√ß√£o autom√°tica de verba por estrat√©gia, plataforma e localiza√ß√£o.**
""")

# Estado da sess√£o para armazenar resultados intermedi√°rios
if 'plano_completo' not in st.session_state:
    st.session_state.plano_completo = {}
if 'current_step' not in st.session_state:
    st.session_state.current_step = 0

# Fun√ß√µes de gera√ß√£o de conte√∫do com IA
def gerar_recomendacao_estrategica(params: Dict[str, Any]) -> str:
    """Gera a recomenda√ß√£o estrat√©gica inicial"""
    prompt = f"""
    Como especialista em planejamento de m√≠dia digital, analise os seguintes par√¢metros e forne√ßa uma recomenda√ß√£o estrat√©gica:

    **Objetivo da Campanha:** {params['objetivo_campanha']}
    **Tipo de Campanha:** {params['tipo_campanha']}
    **Budget Total:** R$ {params['budget']:,.2f}
    **Ferramentas/Plataformas:** {", ".join(params['ferramentas'])}
    **Localiza√ß√£o Prim√°ria:** {params['localizacao_primaria']}
    **Localiza√ß√£o Secund√°ria:** {params['localizacao_secundaria']}
    **Tipo de P√∫blico:** {params['tipo_publico']}
    **Tipos de Criativo:** {", ".join(params['tipo_criativo'])}
    **OKRs:** {", ".join(params['okrs'])}
    **Observa√ß√µes:** {params['observacoes'] or "Nenhuma"}

    Forne√ßa:
    1. An√°lise estrat√©gica (150-200 palavras)
    2. Principais oportunidades identificadas
    3. Riscos potenciais a considerar
    4. Recomenda√ß√£o geral de abordagem

    Formato: Markdown com headers (##, ###)
    """
    response = modelo_texto.generate_content(prompt)
    return response.text

def gerar_distribuicao_budget(params: Dict[str, Any], recomendacao_estrategica: str) -> str:
    """Gera a distribui√ß√£o de budget baseada na recomenda√ß√£o estrat√©gica"""
    prompt = f"""
    Com base na seguinte recomenda√ß√£o estrat√©gica:
    {recomendacao_estrategica}

    E nos par√¢metros originais:
    - Budget: R$ {params['budget']:,.2f}
    - Plataformas: {", ".join(params['ferramentas'])}
    - Localiza√ß√µes: Prim√°ria ({params['localizacao_primaria']}), Secund√°ria ({params['localizacao_secundaria']})
    - OKRs: {", ".join(params['okrs'])}

    Crie uma tabela detalhada de distribui√ß√£o de budget com:
    1. Divis√£o por plataforma (% e valor)
    2. Aloca√ß√£o geogr√°fica (prim√°ria vs secund√°ria)
    3. Tipos de criativos recomendados para cada
    4. Justificativa para cada aloca√ß√£o

    Inclua tamb√©m uma breve an√°lise (50-100 palavras) explicando a l√≥gica de distribui√ß√£o.

    Formato: Markdown com tabelas (use | para divis√£o)
    """
    response = modelo_texto.generate_content(prompt)
    return response.text

def gerar_previsao_resultados(params: Dict[str, Any], recomendacao_estrategica: str, distribuicao_budget: str) -> str:
    """Gera previs√£o de resultados baseada nos par√¢metros"""
    prompt = f"""
    Com base na estrat√©gia:
    {recomendacao_estrategica}

    E na distribui√ß√£o de budget:
    {distribuicao_budget}

    Estime os resultados esperados para esta campanha considerando:
    - Objetivo: {params['objetivo_campanha']}
    - OKRs: {", ".join(params['okrs'])}
    - Budget total: R$ {params['budget']:,.2f}

    Forne√ßa:
    1. Tabela com m√©tricas esperadas por plataforma (impress√µes, alcance, engajamento, etc.)
    2. Estimativa de CPM, CPC, CTR conforme relevante
    3. An√°lise de potencial desempenho (50-100 palavras)
    4. Principais KPI's a monitorar

    Use dados de benchmark do setor quando aplic√°vel.

    Formato: Markdown com tabelas
    """
    response = modelo_texto.generate_content(prompt)
    return response.text

def gerar_recomendacoes_publico(params: Dict[str, Any], recomendacao_estrategica: str) -> str:
    """Gera recomenda√ß√µes detalhadas de p√∫blico-alvo"""
    prompt = f"""
    Para a campanha com os seguintes par√¢metros:
    - Tipo de P√∫blico: {params['tipo_publico']}
    - Objetivo: {params['objetivo_campanha']}
    - Plataformas: {", ".join(params['ferramentas'])}

    E considerando a estrat√©gia geral:
    {recomendacao_estrategica}

    Desenvolva recomenda√ß√µes detalhadas de p√∫blico-alvo incluindo:
    1. Segmenta√ß√£o recomendada para cada plataforma
    2. Par√¢metros de targeting espec√≠ficos
    3. Tamanho estimado do p√∫blico
    4. Estrat√©gias de expans√£o (LAL, interesses, etc.)
    5. Considera√ß√µes sobre frequ√™ncia e satura√ß√£o

    Formato: Markdown com listas e headers
    """
    response = modelo_texto.generate_content(prompt)
    return response.text

def gerar_cronograma(params: Dict[str, Any], recomendacao_estrategica: str, distribuicao_budget: str) -> str:
    """Gera cronograma de implementa√ß√£o"""
    prompt = f"""
    Com base na estrat√©gia:
    {recomendacao_estrategica}

    E na distribui√ß√£o de budget:
    {distribuicao_budget}

    Crie um cronograma detalhado para implementa√ß√£o desta campanha considerando:
    - Budget total: R$ {params['budget']:,.2f}
    - Plataformas: {", ".join(params['ferramentas'])}
    - OKRs: {", ".join(params['okrs'])}

    Inclua:
    1. Fases de implementa√ß√£o (pr√©-lan√ßamento, lan√ßamento, otimiza√ß√£o)
    2. Distribui√ß√£o temporal do budget
    3. Principais marcos e entreg√°veis
    4. Recomenda√ß√µes de frequ√™ncia de ajustes

    Formato: Markdown com tabelas ou listas numeradas
    """
    response = modelo_texto.generate_content(prompt)
    return response.text

# Fun√ß√£o para extrair se√ß√µes de forma segura
def extract_section(response_text: str, section_title: str) -> str:
    """Extrai uma se√ß√£o espec√≠fica do texto da resposta"""
    if section_title in response_text:
        parts = response_text.split(section_title)
        if len(parts) > 1:
            next_section = parts[1].find("##")
            if next_section != -1:
                return parts[1][:next_section].strip()
            return parts[1].strip()
    return "Se√ß√£o n√£o encontrada na resposta."

# Abas principais
tab1, tab2 = st.tabs(["üìã Criar Novo Plano", "üìä Exemplos e Modelos"])

with tab1:
    st.header("Informa√ß√µes do Plano de M√≠dia")
    
    with st.form("plano_midia_form"):
        col1, col2 = st.columns(2)
        
        with col1:
            objetivo_campanha = st.selectbox(
                "Objetivo da Campanha*",
                ["Awareness", "Considera√ß√£o", "Compra/Leads"],
                index=0
            )
            
            tipo_campanha = st.selectbox(
                "Tipo de Campanha*",
                ["Alcance", "Engajamento", "Tr√°fego", "Convers√£o"],
                index=0
            )
            
            budget = st.number_input(
                "Budget Total (R$)*",
                min_value=1000,
                value=100000,
                step=1000
            )
            
            ferramentas = st.multiselect(
                "Ferramentas/Plataformas*",
                ["Meta Ads (Facebook/Instagram)", "Google Ads", "TikTok", "LinkedIn", 
                 "YouTube", "M√≠dia Program√°tica", "Twitter", "Pinterest"],
                default=["Meta Ads (Facebook/Instagram)", "Google Ads"]
            )
            
        with col2:
            localizacao_primaria = st.text_input(
                "Localiza√ß√£o Prim√°ria (Estados)*",
                placeholder="Ex: MT, GO, RS",
                value="MT, GO, RS"
            )
            
            localizacao_secundaria = st.text_input(
                "Localiza√ß√£o Secund√°ria (Estados)",
                placeholder="Ex: SP, MG, RJ",
                value="SP, MG, RJ"
            )
            
            tipo_publico = st.selectbox(
                "Tipo de P√∫blico*",
                ["Interesses", "Lookalike Audience (LAL)", "Base de Clientes", 
                 "Retargeting", "Comportamento", "Demogr√°fico"],
                index=0
            )
            
            tipo_criativo = st.multiselect(
                "Tipos de Criativo*",
                ["Est√°tico", "V√≠deo", "Carrossel", "Motion", "Story", "Cole√ß√£o"],
                default=["Est√°tico", "V√≠deo"]
            )
        
        okrs = st.multiselect(
            "OKRs (Objetivos-chave)*",
            ["Impress√µes", "Engajamento", "Sess√µes", "Video Views", 
             "CTR", "Convers√µes", "ROAS", "Alcance"],
            default=["Impress√µes", "Engajamento"]
        )
        
        observacoes = st.text_area(
            "Observa√ß√µes Adicionais",
            placeholder="Informa√ß√µes extras sobre a campanha, concorrentes, etc."
        )
        
        submitted = st.form_submit_button("Gerar Plano de M√≠dia")
    
    if submitted:
        if not objetivo_campanha or not tipo_campanha or not budget or not ferramentas:
            st.error("Por favor, preencha todos os campos obrigat√≥rios (*)")
        else:
            # Armazenar par√¢metros na sess√£o
            params = {
                'objetivo_campanha': objetivo_campanha,
                'tipo_campanha': tipo_campanha,
                'budget': budget,
                'ferramentas': ferramentas,
                'localizacao_primaria': localizacao_primaria,
                'localizacao_secundaria': localizacao_secundaria,
                'tipo_publico': tipo_publico,
                'tipo_criativo': tipo_criativo,
                'okrs': okrs,
                'observacoes': observacoes
            }
            
            st.session_state.current_step = 1
            st.session_state.params = params
            
    # Processamento em etapas
    if st.session_state.current_step >= 1:
        with st.spinner('Gerando recomenda√ß√£o estrat√©gica...'):
            if 'recomendacao_estrategica' not in st.session_state.plano_completo:
                st.session_state.plano_completo['recomendacao_estrategica'] = gerar_recomendacao_estrategica(st.session_state.params)
            
            st.markdown("## üìå Recomenda√ß√£o Estrat√©gica")
            st.markdown(st.session_state.plano_completo['recomendacao_estrategica'])
            
            if st.button("Pr√≥xima Etapa: Distribui√ß√£o de Budget"):
                st.session_state.current_step = 2
    
    if st.session_state.current_step >= 2:
        with st.spinner('Calculando distribui√ß√£o de budget...'):
            if 'distribuicao_budget' not in st.session_state.plano_completo:
                st.session_state.plano_completo['distribuicao_budget'] = gerar_distribuicao_budget(
                    st.session_state.params,
                    st.session_state.plano_completo['recomendacao_estrategica']
                )
            
            st.markdown("## üìä Distribui√ß√£o de Budget")
            st.markdown(st.session_state.plano_completo['distribuicao_budget'])
            
            if st.button("Pr√≥xima Etapa: Previs√£o de Resultados"):
                st.session_state.current_step = 3
    
    if st.session_state.current_step >= 3:
        with st.spinner('Estimando resultados...'):
            if 'previsao_resultados' not in st.session_state.plano_completo:
                st.session_state.plano_completo['previsao_resultados'] = gerar_previsao_resultados(
                    st.session_state.params,
                    st.session_state.plano_completo['recomendacao_estrategica'],
                    st.session_state.plano_completo['distribuicao_budget']
                )
            
            st.markdown("## üìà Previs√£o de Resultados")
            st.markdown(st.session_state.plano_completo['previsao_resultados'])
            
            if st.button("Pr√≥xima Etapa: Recomenda√ß√µes de P√∫blico"):
                st.session_state.current_step = 4
    
    if st.session_state.current_step >= 4:
        with st.spinner('Desenvolvendo recomenda√ß√µes de p√∫blico...'):
            if 'recomendacoes_publico' not in st.session_state.plano_completo:
                st.session_state.plano_completo['recomendacoes_publico'] = gerar_recomendacoes_publico(
                    st.session_state.params,
                    st.session_state.plano_completo['recomendacao_estrategica']
                )
            
            st.markdown("## üéØ Recomenda√ß√µes de P√∫blico")
            st.markdown(st.session_state.plano_completo['recomendacoes_publico'])
            
            if st.button("Pr√≥xima Etapa: Cronograma"):
                st.session_state.current_step = 5
    
    if st.session_state.current_step >= 5:
        with st.spinner('Criando cronograma...'):
            if 'cronograma' not in st.session_state.plano_completo:
                st.session_state.plano_completo['cronograma'] = gerar_cronograma(
                    st.session_state.params,
                    st.session_state.plano_completo['recomendacao_estrategica'],
                    st.session_state.plano_completo['distribuicao_budget']
                )
            
            st.markdown("## üìÖ Cronograma Sugerido")
            st.markdown(st.session_state.plano_completo['cronograma'])
            
            # Bot√£o para baixar o plano completo
            plano_completo = "\n\n".join([
                "# üìä Plano de M√≠dia Completo\n",
                f"**Campanha:** {st.session_state.params['objetivo_campanha']}",
                f"**Budget:** R$ {st.session_state.params['budget']:,.2f}\n",
                "## üìå Recomenda√ß√£o Estrat√©gica",
                st.session_state.plano_completo['recomendacao_estrategica'],
                "## üìä Distribui√ß√£o de Budget",
                st.session_state.plano_completo['distribuicao_budget'],
                "## üìà Previs√£o de Resultados",
                st.session_state.plano_completo['previsao_resultados'],
                "## üéØ Recomenda√ß√µes de P√∫blico",
                st.session_state.plano_completo['recomendacoes_publico'],
                "## üìÖ Cronograma Sugerido",
                st.session_state.plano_completo['cronograma']
            ])
            
            st.download_button(
                label="üì• Baixar Plano Completo",
                data=plano_completo,
                file_name=f"plano_midia_{st.session_state.params['objetivo_campanha']}_{st.session_state.params['budget']}.md",
                mime="text/markdown"
            )

with tab2:
    st.header("Modelos e Exemplos de Planejamento")
    
    st.markdown("""
    ### üìã Modelo de Plano de M√≠dia (Exemplo)
    
    **Campanha:** Syngenta - Awareness
    **Budget:** R$ 100.000,00
    """)
    
    # Tabela de exemplo
    exemplo_data = {
        "Plataforma": ["Meta Ads", "Google Ads", "TikTok", "Total"],
        "% Budget": ["45%", "35%", "20%", "100%"],
        "Investimento (R$)": ["45.000", "35.000", "20.000", "100.000"],
        "Localiza√ß√£o Prim√°ria": ["70%", "65%", "75%", ""],
        "Localiza√ß√£o Secund√°ria": ["30%", "35%", "25%", ""],
        "Criativos": ["V√≠deo (60%), Est√°tico (40%)", "Display (50%), V√≠deo (50%)", "V√≠deo (100%)", ""],
        "OKRs Principais": ["Impress√µes, Alcance", "Impress√µes, CTR", "Video Views", ""]
    }
    
    st.dataframe(pd.DataFrame(exemplo_data), hide_index=True)
    
    st.markdown("""
    ### üìä M√©tricas Esperadas (Exemplo)
    """)
    
    metricas_data = {
        "Plataforma": ["Meta Ads", "Google Ads", "TikTok"],
        "Impress√µes": ["2.500.000", "1.800.000", "1.200.000"],
        "CPM (R$)": ["18,00", "19,44", "16,67"],
        "Alcance": ["1.100.000", "850.000", "600.000"],
        "Video Views": ["450.000", "300.000", "800.000"],
        "Engajamento": ["3,2%", "1,8%", "4,5%"]
    }
    
    st.dataframe(pd.DataFrame(metricas_data), hide_index=True)
    
    st.markdown("""
    ### üìå Dicas para Otimiza√ß√£o
    1. **Priorize plataformas** conforme o p√∫blico-alvo
    2. **Teste diferentes criativos** e aloca√ß√µes de budget
    3. **Ajuste geotargeting** baseado em performance
    4. **Monitore frequ√™ncia** para evitar satura√ß√£o
    5. **Reavalie semanalmente** e redistribua verba
    """)

# Rodap√©
st.markdown("---")
st.caption("""
Ferramenta de IA para Planejamento de M√≠dia - Otimize suas campanhas com aloca√ß√£o inteligente de budget.
""")
